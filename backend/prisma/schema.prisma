generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/*
  Enums
*/
enum LeadStatus {
  New
  Contacted
  Qualified
  Proposal
  Won
  Lost
}

enum ActivityType {
  Note
  Call
  Meeting
  Email
  StatusChange
}

// removed enum Role - we will use a Role model instead

enum LeadHistoryAction {
  CREATE
  UPDATE
  TRANSFER
  DELETE
}

/*
  Models
*/
model Role {
  id    Int     @id @default(autoincrement())
  name  String  @unique
  users User[]
}

model User {
  id            Int            @id @default(autoincrement())
  name          String
  email         String         @unique
  password      String
  // role relation (was an enum before)
  roleId        Int?
  role          Role?          @relation(fields: [roleId], references: [id])
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  // relations
  leads         Lead[]         @relation("OwnerLeads")
  activities    Activity[]
  notifications Notification[]
  sessions      Session[]

  // Opposite relation for LeadHistory
  leadHistories LeadHistory[]  @relation("ActorHistories")

  @@index([email])
  @@index([roleId])
}

model Lead {
  id          Int           @id @default(autoincrement())
  name        String
  email       String?
  phone       String?
  status      LeadStatus    @default(New)
  source      String?
  ownerId     Int?
  owner       User?         @relation("OwnerLeads", fields: [ownerId], references: [id])
  description String?
  metadata    Json?
  value       Float?
  isDeleted   Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  activities  Activity[]
  histories   LeadHistory[] @relation("LeadHistories")

  @@index([ownerId])
  @@index([status])
  @@index([createdAt])
  @@index([isDeleted])
}

model Activity {
  id        Int          @id @default(autoincrement())
  type      ActivityType
  content   String
  leadId    Int
  userId    Int
  metadata  Json?
  createdAt DateTime     @default(now())

  lead Lead @relation(fields: [leadId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@index([userId])
  @@index([createdAt])
}

/*
  LeadHistory: new structure to store atomic actions + JSON diffs
*/
model LeadHistory {
  id        Int               @id @default(autoincrement())
  leadId    Int
  action    LeadHistoryAction
  actorId   Int
  actor     User              @relation("ActorHistories", fields: [actorId], references: [id])
  lead      Lead              @relation("LeadHistories", fields: [leadId], references: [id], onDelete: Cascade)
  changes   Json?             // JSON object describing the diff or snapshot
  note      String?
  createdAt DateTime          @default(now())

  @@index([leadId])
  @@index([actorId])
  @@index([createdAt])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String
  payload   Json
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model Session {
  id           Int      @id @default(autoincrement())
  userId       Int
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}
